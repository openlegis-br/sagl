<dtml-if hdn_cod_norma>
    <dtml-call expr="REQUEST.set('metodo', zsql.norma_juridica_atualizar_zsql)">
<dtml-else> 
    <dtml-call expr="REQUEST.set('metodo', zsql.norma_juridica_incluir_zsql)">
</dtml-if>

<dtml-if expr="lst_tip_id_basica!=''">
    <dtml-in expr="zsql.materia_obter_zsql(tip_id_basica=lst_tip_id_basica, num_ident_basica=txt_num_ident_basica, ano_ident_basica=txt_ano_ident_basica)">
        <dtml-call expr="REQUEST.set('cod_materia', cod_materia)">
    <dtml-else>
        <dtml-call expr="REQUEST.set('erro', 1)">
        <dtml-let mensagem="'A matéria legislativa informada não existe no sistema!'">
            <dtml-var mensagem_emitir>
        </dtml-let>         
    </dtml-in>
<dtml-else>
    <dtml-call expr="REQUEST.set('cod_materia', '')">
</dtml-if>

<dtml-unless erro>
    <dtml-if expr="(hdn_tip_norma_ant!=lst_tip_norma or hdn_num_norma_ant!=txt_num_norma or hdn_ano_norma_ant!=txt_ano_norma) and zsql.norma_juridica_obter_zsql(tip_norma=lst_tip_norma, num_norma=txt_num_norma, ano_norma=txt_ano_norma, ind_excluido=0)">
        <dtml-let mensagem="'Já existe uma norma jurídica idêntica!'">
            <dtml-var mensagem_emitir>
        </dtml-let>
    <dtml-else> 
        <dtml-unless rad_ind_complemento>
            <dtml-call expr="REQUEST.set('rad_ind_complemento', '')">
        </dtml-unless>

        <dtml-if chk_assunto_norma>
           <dtml-call expr="REQUEST.set('lst_assunto_norma', _.string.join(chk_assunto_norma,','))">
        </dtml-if>

        <dtml-unless chk_assunto_norma>
            <dtml-call expr="REQUEST.set('lst_assunto_norma', '1')">
        </dtml-unless>

        <dtml-try>
            <dtml-call expr="metodo(cod_norma              = hdn_cod_norma,
                                    tip_norma              = lst_tip_norma,
                                    num_norma              = txt_num_norma,
                                    ano_norma              = txt_ano_norma,
                                    tip_esfera_federacao   = lst_tip_esfera_federacao,
                                    cod_materia            = cod_materia,
                                    dat_norma              = pysc.data_converter_pysc(data=txt_dat_norma),
                                    dat_publicacao         = pysc.data_converter_pysc(data=txt_dat_publicacao),
                                    des_veiculo_publicacao = txt_des_veiculo_publicacao,
                                    num_pag_inicio_publ    = txt_num_pag_inicio_publ,
                                    num_pag_fim_publ       = txt_num_pag_fim_publ,
                                    txt_ementa             = txa_txt_ementa,
                                    txt_indexacao          = txa_txt_indexacao,
                                    txt_observacao         = txa_txt_observacao,
                                    ind_complemento        = rad_ind_complemento,
                                    cod_assunto            = lst_assunto_norma,
                                    cod_situacao           = lst_tip_situacao_norma)">

            <dtml-unless hdn_cod_norma>
              <dtml-in expr="zsql.norma_juridica_incluida_codigo_obter_zsql()">
                 <dtml-call "REQUEST.set('hdn_cod_norma', cod_norma)">
              </dtml-in>
            </dtml-unless>

        <dtml-else>      
            <dtml-call expr="REQUEST.set('erro', 0)">              
            <dtml-if expr="radTI=='I' or radTI=='S'">                
                <dtml-call expr="REQUEST.set('existe_arquivo', 0)">        
                <dtml-if expr="(_.int(hdn_file)==1)">
                    <dtml-if hdn_cod_norma>
                        <dtml-call expr="REQUEST.set('id_documento', _.str(hdn_cod_norma)+'_'+sagl_documentos.norma_juridica.nom_documento)">
                        <dtml-call expr="REQUEST.set('id_documento_assinado', _.str(hdn_cod_norma)+ '_' + 'texto_integral_signed.pdf')">
                        <dtml-if "_.hasattr(sagl_documentos.norma_juridica,id_documento)">
                            <dtml-let documento="_.getattr(sagl_documentos.norma_juridica,id_documento) ">
                                <dtml-call expr="REQUEST.set('existe_arquivo', 1)">
                                <dtml-try>
                                    <dtml-call "documento.manage_upload(file=file_nom_arquivo)">
                                <dtml-except>
                                    <dtml-call expr="REQUEST.set('erro', 1)">              
                                </dtml-try>
                            </dtml-let>
                        </dtml-if>
                        <dtml-if "_.hasattr(sagl_documentos.norma_juridica,id_documento_assinado)">
                           <dtml-call expr="sagl_documentos.norma_juridica.manage_delObjects(id_documento_assinado)">
                        </dtml-if>
                        <dtml-in expr="zsql.assinatura_documento_obter_zsql(codigo=hdn_cod_norma,tipo_doc='norma')">
                          <dtml-try>
                            <dtml-call expr="zsql.assinatura_documento_excluir_zsql(
                                cod_assinatura_doc  = cod_assinatura_doc,
                                codigo              = codigo,
                                tipo_doc            = tipo_doc)">
                          <dtml-except>
                            <dtml-call expr="REQUEST.set('erro', 1)">
                          </dtml-try>
                        </dtml-in>
                    </dtml-if>
                    <dtml-if "not existe_arquivo">
                        <dtml-try>            
                            <dtml-call expr="sagl_documentos.norma_juridica.manage_addFile(id=id_documento,file=file_nom_arquivo)">
                        <dtml-except> 
                            <dtml-call expr="REQUEST.set('erro', 1)">              
                        </dtml-try>      
                    </dtml-if>
                </dtml-if>
            <dtml-elif expr="radTI=='E'">
                <dtml-if hdn_cod_norma>
                    <dtml-call expr="REQUEST.set('id_documento', _.str(hdn_cod_norma)+'_'+sagl_documentos.norma_juridica.nom_documento)">
                    <dtml-call expr="REQUEST.set('id_documento_assinado', _.str(hdn_cod_norma)+ '_' + 'texto_integral_signed.pdf')">
                    <dtml-if "_.hasattr(sagl_documentos.norma_juridica,id_documento_assinado)">
                       <dtml-call expr="sagl_documentos.norma_juridica.manage_delObjects(id_documento_assinado)">
                    </dtml-if>
                    <dtml-call expr="sagl_documentos.norma_juridica.manage_delObjects(id_documento)">
                    <dtml-call expr="sagl_documentos.norma_juridica.Catalog.removerCatalogo(hdn_cod_norma)">
                    <dtml-in expr="zsql.assinatura_documento_obter_zsql(codigo=hdn_cod_norma,tipo_doc='norma')">
                      <dtml-try>
                        <dtml-call expr="zsql.assinatura_documento_excluir_zsql(
                            cod_assinatura_doc  = cod_assinatura_doc,
                            codigo              = codigo,
                            tipo_doc            = tipo_doc)">
                      <dtml-except>
                        <dtml-call expr="REQUEST.set('erro', 1)">
                      </dtml-try>
                    </dtml-in>
                </dtml-if>
            </dtml-if>

            <dtml-call expr="sagl_documentos.norma_juridica.Catalog.atualizarCatalogo(cod_norma=hdn_cod_norma)">

           <dtml-let mensagem="'Norma Jurídica salva com sucesso!'" sucesso="1" cod_norma="hdn_cod_norma" url="'norma_juridica_mostrar_proc?cod_norma='+hdn_cod_norma">
               <dtml-var norma_juridica_mostrar_proc>
           </dtml-let>
        </dtml-try>
    </dtml-if> 
</dtml-unless>
